# hprof-slurp

`hprof-slurp` is a CLI analyzing JVM heap dumps using the binary `hprof` format.

The main goal is to enable the analysis of huge heap dumps which are much bigger than the amount of RAM available on the host system. 

## Features

- displays top `n` allocated classes.
- displays number of instances per class.
- displays largest instance size per class.
- list all String found.
- does not load the entire dump file in memory.
- easy to use.

## Status

This tool is under active development and has not been battle tested.

- Tested only with `JAVA PROFILE 1.0.2` & `JAVA PROFILE 1.0.1` formats.
- Does not support dumps generated by 32 bits JVM for the moment.
- The analysis results might not be entirely correct.

## Usage

```
./hprof-slurp --help
hprof-slurp 0.1.0
Arnaud Gourlay <arnaud.gourlay@gmail.com>
JVM heap dump hprof file analyzer

USAGE:
    hprof-slurp [FLAGS] [OPTIONS] --inputFile <inputFile>

FLAGS:
    -d, --debug          debug info
    -h, --help           Prints help information
    -l, --listStrings    list all Strings found
    -V, --version        Prints version information

OPTIONS:
    -i, --inputFile <inputFile>    binary hprof input file
    -t, --top <top>                the top results to display [default: 20]
```

Example:

```
./hprof-slurp -i "/path/to/file/my-heap-file.bin"
```

## Installation

Build the project using [Cargo](https://doc.rust-lang.org/stable/cargo/getting-started/installation.html)

Then run the following command in the project directory:

`cargo install --path=.`

## How it works

The binary file is parsed in a streaming fashion and only the necessary information is extracted for analysis.

The `hprof` specification used can be found [here](https://hg.openjdk.java.net/jdk/jdk/file/ee1d592a9f53/src/hotspot/share/services/heapDumper.cpp#l62).

## HPROF

`hprof` files are sometimes generated in case of a JVM crash depending on your runtime configuration.

It can also be done manually by triggering a heap dump using `jmap`.

Example:

`jmap -dump:format=b,file=my-heap-file.bin <pid>`

## Prior art of HPROF parsing

Several projects have been very useful while researching and implementing this tool.
They have provided guidance and inspiration in moments of uncertainty.

- https://github.com/monoid/hprof_dump_parser
- https://github.com/eaftan/hprof-parser
- https://github.com/Trainologic/HProfParse

## TODO

- use stacktrace/frame dump to compute allocation sites
- parse GC sub-records in a streaming fashion as well.
- support 32 bits dumps.