# hprof-slurp
[![Build](https://github.com/agourlay/hprof-slurp/actions/workflows/ci.yml/badge.svg)](https://github.com/agourlay/hprof-slurp/actions/workflows/ci.yml)

`hprof-slurp` is a specialized JVM heap dump analyzer.

It is named after the `hprof` format which is the used by the [JDK](https://hg.openjdk.java.net/jdk/jdk/file/ee1d592a9f53/src/hotspot/share/services/heapDumper.cpp#l62) to encode heap dumps.

The underlying motivation is to enable the analysis of **huge** heap dumps which are much larger than the amount of RAM available on the host system.

`hprof-slurp` processes dump files in a **streaming fashion in a single pass** without storing intermediary results on the host.

This tool provides a fast and cheap overview of dump file in order to decide if it makes sense to spin up an expensive beefy instance to run more exhaustive tools.

## Features

- displays top `n` allocated classes.
- displays number of instances per class.
- displays largest instance size per class.
- can list all `Strings` found.

## Usage

```
./hprof-slurp --help
hprof-slurp x.x.x
Arnaud Gourlay <arnaud.gourlay@gmail.com>
JVM heap dump hprof file analyzer

USAGE:
    hprof-slurp [OPTIONS] --inputFile <inputFile>

OPTIONS:
    -d, --debug                    debug info
    -h, --help                     Print help information
    -i, --inputFile <inputFile>    binary hprof input file
    -l, --listStrings              list all Strings found
    -t, --top <top>                the top results to display [default: 20]
    -V, --version                  Print version information
```

Example:

```
./hprof-slurp -i "test-heap-dumps/hprof-64.bin"
```

```
Found a total of 2.53MiB of instances allocated on the heap.

Top 20 allocated classes:

Total size | Instances |     Largest | Class name
----------------------------------------------------------------------------------
   1.99MiB |       436 |   634.78KiB | int[]
 197.11KiB |      1991 |    16.02KiB | char[]
  85.25KiB |       443 |     8.02KiB | byte[]
  47.38KiB |      1516 |  32.00bytes | java/lang/String
  45.42KiB |       560 |     8.02KiB | java/lang/Object[]
  15.26KiB |       126 | 124.00bytes | java/lang/reflect/Field
  14.77KiB |       378 |  40.00bytes | java/util/LinkedList$Node
   9.94KiB |       212 |  48.00bytes | java/util/HashMap$Node
   8.91KiB |       190 |  48.00bytes | java/util/LinkedList
   8.42KiB |        98 |  88.00bytes | java/lang/ref/SoftReference
   6.05KiB |       258 |  24.00bytes | java/lang/Integer
   5.91KiB |        18 |     2.02KiB | java/util/HashMap$Node[]
   5.86KiB |       150 |  40.00bytes | java/lang/StringBuilder
   5.44KiB |       116 |  48.00bytes | java/util/Hashtable$Entry
   5.05KiB |        38 | 136.00bytes | sun/util/locale/LocaleObjectCache$CacheEntry
   5.00KiB |        40 | 128.00bytes | java/lang/ref/Finalizer
   3.50KiB |        32 | 112.00bytes | java/net/URL
   3.42KiB |        73 |  48.00bytes | java/io/File
   3.17KiB |        12 | 776.00bytes | java/util/Hashtable$Entry[]
   3.13KiB |        56 | 144.00bytes | java/lang/String[]
```

## Performance

On modern hardware `hprof-slurp` can process heap dump files at around 700 MiB/s.

To maximize performance make sure to run on a host with at least 4 cores.

## Limitations

- Tested only with `JAVA PROFILE 1.0.2` & `JAVA PROFILE 1.0.1` formats.
- Does not support dumps generated by 32 bits JVM.

## Generate a heap dump

Heap dump files are sometimes generated in case of a JVM crash depending on your runtime configuration.

It can also be done manually by triggering a heap dump using `jmap`.

Example:

`jmap -dump:format=b,file=my-hprof-file.bin <pid>`

## Prior art of HPROF parsing

Several projects have been very useful while researching and implementing this tool.
They have provided guidance and inspiration in moments of uncertainty.

- https://github.com/monoid/hprof_dump_parser
- https://github.com/eaftan/hprof-parser
